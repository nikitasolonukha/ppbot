<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>–†–µ—Ü–µ–ø—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            touch-action: none;
        }

        #watermark-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            opacity: 0.08;
            overflow: hidden;
        }

        .watermark-text {
            position: absolute;
            color: #fff;
            font-size: 14px;
            transform: rotate(25deg);
            white-space: nowrap;
            font-weight: 300;
        }

        #container {
            position: relative;
            z-index: 1;
            padding: 20px;
            max-width: 100%;
            min-height: 100vh;
        }

        #canvas-container {
            position: relative;
            width: 100%;
            margin: 0 auto;
            background: #000;
        }

        #recipe-canvas {
            display: block;
            width: 100%;
            height: auto;
            max-width: 100%;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        #error-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 24px;
            z-index: 10000;
            color: #ff4444;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            z-index: 10001;
        }

        @media print {
            body * {
                display: none !important;
            }
            body::before {
                content: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω";
                display: block !important;
                font-size: 24px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="watermark-overlay"></div>
    <div id="container">
        <canvas id="recipe-canvas"></canvas>
    </div>
    <div id="error-message">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="debug-info" style="position:fixed;top:10px;left:10px;background:rgba(255,0,0,0.8);color:#fff;padding:10px;font-size:12px;z-index:10002;max-width:300px;display:none;"></div>

    <script>
        // ‚ö†Ô∏è –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –≤ WebApp. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±—Ä–∞—É–∑–µ—Ä–∞.

        const tg = window.Telegram?.WebApp;
        if (!tg) {
            document.body.innerHTML = '<div id="error-message" style="display:block;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>';
            throw new Error('Not in Telegram WebApp');
        }

        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe?.user;
        const userId = user?.id || 'unknown';
        const username = user?.username || `user_${userId}`;
        const currentTime = new Date().toLocaleString('ru-RU');

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–∞ –∏–∑ initData –∏–ª–∏ URL
        const urlParams = new URLSearchParams(window.location.search);
        let recipeData = {
            name: '–†–µ—Ü–µ–ø—Ç',
            calories: 0,
            proteins: 0,
            fats: 0,
            carbs: 0,
            ingredients: ['–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã'],
            instructions: ['–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã']
        };
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
        const debugInfo = document.getElementById('debug-info');
        debugInfo.style.display = 'block';
        
        try {
            const dataParam = urlParams.get('data');
            debugInfo.innerHTML = `URL –¥–ª–∏–Ω–∞: ${window.location.href.length}<br>data param: ${dataParam ? '–µ—Å—Ç—å (' + dataParam.length + ' —Å–∏–º–≤–æ–ª–æ–≤)' : '–ù–ï–¢'}`;
            
            if (dataParam) {
                // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ base64 —Ñ–æ—Ä–º–∞—Ç–µ
                let decoded;
                try {
                    // –ü—Ä–æ–±—É–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å base64
                    decoded = atob(dataParam);
                    debugInfo.innerHTML += '<br>‚úÖ Base64 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω';
                } catch (e) {
                    // –ï—Å–ª–∏ –Ω–µ base64, –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π URL decode (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                    decoded = decodeURIComponent(dataParam);
                    debugInfo.innerHTML += '<br>‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω URL decode';
                }
                recipeData = JSON.parse(decoded);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã
                if (!recipeData.name || !Array.isArray(recipeData.ingredients)) {
                    throw new Error('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç–∞');
                }
                // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã
                debugInfo.innerHTML += `<br>‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: ${recipeData.name}<br>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: ${recipeData.ingredients.length}`;
                console.log('–î–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ–ª—É—á–µ–Ω—ã:', recipeData.name, '–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤:', recipeData.ingredients.length);
            } else {
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                debugInfo.innerHTML += '<br>‚ùå –ü–∞—Ä–∞–º–µ—Ç—Ä data –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
                document.getElementById('loading').textContent = '–î–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã';
                console.error('–ü–∞—Ä–∞–º–µ—Ç—Ä data –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ URL');
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–∞:', e);
            debugInfo.innerHTML += `<br>‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
            document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–∞: ' + e.message;
            // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        }

        // Watermark –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        function generateWatermark() {
            const overlay = document.getElementById('watermark-overlay');
            overlay.innerHTML = '';
            const watermarkText = `${username} | ${userId} | ${currentTime}`;
            const spacing = 200;
            const rows = Math.ceil(window.innerHeight / spacing) + 2;
            const cols = Math.ceil(window.innerWidth / spacing) + 2;

            for (let i = -1; i < rows; i++) {
                for (let j = -1; j < cols; j++) {
                    const span = document.createElement('span');
                    span.className = 'watermark-text';
                    span.textContent = watermarkText;
                    span.style.left = (j * spacing) + 'px';
                    span.style.top = (i * spacing) + 'px';
                    overlay.appendChild(span);
                }
            }
        }

        // Canvas —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ—Ü–µ–ø—Ç–∞
        function renderRecipe() {
            console.log('renderRecipe –≤—ã–∑–≤–∞–Ω–∞, recipeData:', recipeData);
            const canvas = document.getElementById('recipe-canvas');
            if (!canvas) {
                throw new Error('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç canvas');
            }
            const container = document.getElementById('container');
            const maxWidth = Math.min(window.innerWidth - 40, 600);
            
            canvas.width = maxWidth;
            canvas.height = 1;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
            ctx.textBaseline = 'top';
            ctx.textAlign = 'left';

            let y = 30;
            const padding = 20;
            const lineHeight = 28;
            const sectionSpacing = 20;

            // –ù–∞–∑–≤–∞–Ω–∏–µ
            ctx.font = 'bold 28px -apple-system';
            const nameLines = wrapText(ctx, recipeData.name, maxWidth - padding * 2);
            nameLines.forEach(line => {
                ctx.fillText(line, padding, y);
                y += lineHeight + 4;
            });

            y += sectionSpacing;

            // –ö–ë–ñ–£
            ctx.font = 'bold 20px -apple-system';
            ctx.fillText('üìä –ö–ë–ñ–£', padding, y);
            y += lineHeight + 10;

            ctx.font = '18px -apple-system';
            ctx.fillText(`üî• –ö–∞–ª–æ—Ä–∏–∏: ${recipeData.calories} –∫–∫–∞–ª`, padding, y);
            y += lineHeight;
            ctx.fillText(`ü•ö –ë–µ–ª–∫–∏: ${recipeData.proteins} –≥`, padding, y);
            y += lineHeight;
            ctx.fillText(`üßà –ñ–∏—Ä—ã: ${recipeData.fats} –≥`, padding, y);
            y += lineHeight;
            ctx.fillText(`üçû –£–≥–ª–µ–≤–æ–¥—ã: ${recipeData.carbs} –≥`, padding, y);

            y += sectionSpacing * 2;

            // –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
            ctx.font = 'bold 20px -apple-system';
            ctx.fillText('üõí –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', padding, y);
            y += lineHeight + 10;

            ctx.font = '18px -apple-system';
            const ingredients = Array.isArray(recipeData.ingredients) 
                ? recipeData.ingredients.filter(ing => ing && ing.trim()) 
                : [recipeData.ingredients].filter(ing => ing && ing.trim());
            if (ingredients.length === 0) {
                ingredients.push('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã');
            }
            ingredients.forEach(ing => {
                const ingText = typeof ing === 'string' ? ing : String(ing);
                const lines = wrapText(ctx, `‚Ä¢ ${ingText}`, maxWidth - padding * 2);
                lines.forEach(line => {
                    ctx.fillText(line, padding + 10, y);
                    y += lineHeight;
                });
            });

            y += sectionSpacing * 2;

            // –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ
            ctx.font = 'bold 20px -apple-system';
            ctx.fillText('üë©üèΩ‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ', padding, y);
            y += lineHeight + 10;

            ctx.font = '18px -apple-system';
            const instructions = Array.isArray(recipeData.instructions) 
                ? recipeData.instructions.filter(inst => inst && inst.trim()) 
                : [recipeData.instructions].filter(inst => inst && inst.trim());
            if (instructions.length === 0) {
                instructions.push('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã');
            }
            instructions.forEach((inst, idx) => {
                const instText = typeof inst === 'string' ? inst : String(inst);
                const text = `${idx + 1}. ${instText}`;
                const lines = wrapText(ctx, text, maxWidth - padding * 2);
                lines.forEach(line => {
                    ctx.fillText(line, padding, y);
                    y += lineHeight;
                });
                y += 8;
            });

            // Watermark –Ω–∞ canvas
            ctx.save();
            ctx.globalAlpha = 0.05;
            ctx.fillStyle = '#fff';
            ctx.font = '12px -apple-system';
            ctx.rotate(25 * Math.PI / 180);
            const watermarkCanvas = `${username} | ${userId} | ${currentTime}`;
            const watermarkSpacing = 150;
            for (let i = -2; i < 10; i++) {
                for (let j = -2; j < 10; j++) {
                    ctx.fillText(watermarkCanvas, j * watermarkSpacing, i * watermarkSpacing);
                }
            }
            ctx.restore();

            canvas.height = y + padding;
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        document.addEventListener('copy', (e) => {
            e.preventDefault();
            e.clipboardData.setData('text/plain', '');
            return false;
        });

        document.addEventListener('cut', (e) => {
            e.preventDefault();
            return false;
        });

        document.addEventListener('paste', (e) => {
            e.preventDefault();
            return false;
        });

        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });

        document.addEventListener('selectstart', (e) => {
            e.preventDefault();
            return false;
        });

        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
            return false;
        });

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
        document.addEventListener('keydown', (e) => {
            // Ctrl+C, Ctrl+U, Ctrl+S, Ctrl+P, Ctrl+A
            if (e.ctrlKey && ['c', 'u', 's', 'p', 'a'].includes(e.key.toLowerCase())) {
                e.preventDefault();
                return false;
            }
            // F12, PrintScreen
            if (e.key === 'F12' || e.keyCode === 44) {
                e.preventDefault();
                return false;
            }
            // DevTools shortcuts
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['i', 'j', 'c'].includes(e.key.toLowerCase()))) {
                e.preventDefault();
                return false;
            }
        });

        // Anti DevTools
        let devToolsOpen = false;
        function checkDevTools() {
            const threshold = 160;
            const widthDiff = window.outerWidth - window.innerWidth;
            const heightDiff = window.outerHeight - window.innerHeight;

            if (widthDiff > threshold || heightDiff > threshold) {
                if (!devToolsOpen) {
                    devToolsOpen = true;
                    document.body.innerHTML = '<div id="error-message" style="display:block;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>';
                }
            } else {
                devToolsOpen = false;
            }
        }

        setInterval(checkDevTools, 500);

        // –ó–∞—â–∏—Ç–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                document.body.style.filter = 'blur(30px)';
            } else {
                document.body.style.filter = 'none';
            }
        });

        // –ó–∞—â–∏—Ç–∞ –æ—Ç print
        window.addEventListener('beforeprint', () => {
            document.body.innerHTML = '<div style="font-size:24px;text-align:center;padding:50px;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>';
        });

        window.addEventListener('afterprint', () => {
            location.reload();
        });

        // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', (e) => {
            e.preventDefault();
            e.returnValue = '';
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            try {
                generateWatermark();
                renderRecipe();
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        });

        window.addEventListener('resize', () => {
            generateWatermark();
            renderRecipe();
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—Å–ø–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        Object.defineProperty(window, 'devtools', {
            get: function() {
                return {
                    open: function() {
                        document.body.innerHTML = '<div id="error-message" style="display:block;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>';
                    }
                };
            }
        });

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Å–æ–ª–∏
        const noop = () => {};
        const methods = ['log', 'debug', 'info', 'warn', 'error', 'assert', 'clear', 'count', 'dir', 'dirxml', 'group', 'groupCollapsed', 'groupEnd', 'profile', 'profileEnd', 'table', 'time', 'timeEnd', 'timeStamp', 'trace'];
        methods.forEach(method => {
            console[method] = noop;
        });
    </script>
</body>
</html>
